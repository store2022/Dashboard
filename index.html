<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Login</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="w3-light-grey">
    <div class="w3-container w3-center w3-padding-64">
        <div id="loginContent" class="w3-card-4 w3-white w3-padding" style="max-width:500px;margin:auto;">
            <h2>ระบบเข้าสู่ระบบ</h2>
            <div id="lineLoginBtn" class="w3-padding-16">
                <button onclick="initializeLiff()" class="w3-button w3-green w3-round-large">
                    เข้าสู่ระบบด้วย LINE
                </button>
            </div>
        </div>
        
        <!-- Registration Form (Initially Hidden) -->
        <div id="registrationForm" class="w3-card-4 w3-white w3-padding" style="max-width:500px;margin:auto;display:none;">
            <h2>ลงทะเบียนผู้ใช้ใหม่</h2>
            <form id="userRegForm" class="w3-container">
                <input type="hidden" id="userId" name="userId">
                <p>
                    <label>ชื่อ-นามสกุล</label>
                    <input class="w3-input" type="text" id="fullName" name="fullName" required>
                </p>
                <p>
                    <label>แผนก</label>
                    <input class="w3-input" type="text" id="department" name="department" required>
                </p>
                <button type="submit" class="w3-button w3-green">ลงทะเบียน</button>
            </form>
        </div>

        <!-- Pending Approval Message (Initially Hidden) -->
        <div id="pendingApproval" class="w3-card-4 w3-white w3-padding" style="max-width:500px;margin:auto;display:none;">
            <h2>รอการอนุมัติ</h2>
            <p>บัญชีของคุณอยู่ระหว่างรอการอนุมัติ กรุณารอการติดต่อกลับ</p>
        </div>
    </div>

    <script>
        const LIFF_ID = '2002964196-0Em8MgJk'; // Replace with your LIFF ID
        const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzKBo70nxJYy7RrlpK4UDFUFXe0YuFe-GPr_HrHxaxfz1vVehSNEu2WdtAAIbgEpnbw/exec'; // Replace with your Google Apps Script URL

        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    checkUserRegistration(profile.userId);
                }
            } catch (err) {
                console.error('LIFF Initialization failed', err);
            }
        }

        async function checkUserRegistration(userId) {
            try {
                const response = await fetch(`${GAS_ENDPOINT}?action=checkUser&userId=${userId}`);
                const data = await response.json();
                
                if (data.status === 'not_registered') {
                    // Show registration form
                    document.getElementById('loginContent').style.display = 'none';
                    document.getElementById('registrationForm').style.display = 'block';
                    document.getElementById('userId').value = userId;
                } else if (data.status === 'pending') {
                    // Show pending approval message
                    document.getElementById('loginContent').style.display = 'none';
                    document.getElementById('pendingApproval').style.display = 'block';
                } else if (data.status === 'approved') {
                    // Redirect to dashboard
                    window.location.href = 'dashboard.html';
                }
            } catch (err) {
                console.error('Error checking registration', err);
            }
        }

        document.getElementById('userRegForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const userData = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch(GAS_ENDPOINT, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'register',
                        ...userData
                    })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('registrationForm').style.display = 'none';
                    document.getElementById('pendingApproval').style.display = 'block';
                }
            } catch (err) {
                console.error('Registration failed', err);
            }
        });
    </script>
</body>
</html>
